<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SQLiteREST</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; font-size: 14px; height: 100vh; display: flex; flex-direction: column; }
        .layout { display: flex; flex: 1; min-height: 0; }
        .sidebar { width: 220px; border-right: 1px solid #ccc; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; }
        .sidebar-scroll { flex: 1; overflow-y: auto; }
        .sidebar-footer {
            border-top: 1px solid #ddd;
            padding: 8px 12px;
            font-size: 12px;
            background: #f3f3f3;
        }
        .sidebar-footer a {
            color: #333;
            text-decoration: none;
        }
        .sidebar-footer a:hover { text-decoration: underline; }
        .main { flex: 1; overflow: auto; padding: 12px; }
        .section-title { padding: 8px 12px; font-weight: bold; color: #666; border-bottom: 1px solid #ddd; }
        .nav-item { display: block; width: 100%; padding: 8px 12px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; }
        .nav-item:hover { background: #eee; }
        .nav-item.active { background: #e0e0e0; }
        .nav-item.loading { color: #999; }
        .workspace { max-width: 100%; }
        .workspace h2 { margin-bottom: 10px; font-size: 16px; }
        .workspace h3 { margin: 16px 0 8px; font-size: 14px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; }
        textarea, input[type=text], input[type=number], select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 13px;
            background: #fff;
        }
        textarea { min-height: 80px; resize: vertical; }
        button.run, button.plain-btn {
            padding: 6px 12px;
            background: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }
        button.run:hover, button.plain-btn:hover { background: #555; }
        button.small-btn {
            padding: 3px 8px;
            border: 1px solid #999;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            margin-right: 6px;
        }
        .result-box {
            margin-top: 12px;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            overflow-x: auto;
        }
        .result-box.error { border-color: #c00; background: #fff5f5; }
        .result-box pre { white-space: pre-wrap; word-break: break-all; }
        table.data-table { border-collapse: collapse; width: 100%; margin-top: 8px; }
        table.data-table th, table.data-table td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; vertical-align: top; }
        table.data-table th { background: #f0f0f0; }
        .meta { color: #666; font-size: 12px; margin-bottom: 8px; }
        .pagination { margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        .schema-ddl {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            font-family: ui-monospace, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .empty { color: #999; padding: 12px; }
        .toolbar { display: grid; grid-template-columns: 1fr 120px 120px 100px; gap: 8px; margin-bottom: 8px; }
        .insert-grid { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 10px; }
        .muted { color: #888; font-size: 12px; }
        .row-actions { min-width: 126px; white-space: nowrap; }
        .status-line { margin-top: 8px; font-size: 12px; color: #444; }
        .modal-mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999;
        }
        .modal {
            width: min(860px, 100%);
            max-height: 90vh;
            overflow: auto;
            background: #fff;
            border: 1px solid #bbb;
            padding: 12px;
        }
        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .modal-close {
            border: 1px solid #999;
            background: #fff;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-scroll">
                <div class="section-title">Info</div>
                <button type="button" class="nav-item" data-view="info">System / DB Info</button>
                <div class="section-title">SQL</div>
                <button type="button" class="nav-item active" data-view="sql">Execute SQL</button>
                <div class="section-title">Tables</div>
                <div id="table-list"></div>
            </div>
            <div class="sidebar-footer">
                <a href="https://github.com/weirui-kong/SQLiteREST" target="_blank" rel="noopener noreferrer">GitHub: weirui-kong/SQLiteREST</a>
            </div>
        </aside>
        <main class="main">
            <div id="workspace" class="workspace"></div>
        </main>
    </div>
    <div id="edit-modal-mask" class="modal-mask" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Edit Row">
            <div class="modal-head">
                <span id="edit-modal-title">Edit Row</span>
                <button type="button" id="edit-modal-close" class="modal-close">Close</button>
            </div>
            <div id="edit-modal-body"></div>
            <div id="edit-modal-status" class="status-line"></div>
        </div>
    </div>

    <script>
        const API = '/api/v1';
        const state = {
            tableName: null,
            schema: null,
            page: 1,
            perPage: 50,
            sort: 'rowid',
            order: 'ASC',
            editingRowid: null
        };

        function api(path, options) {
            return fetch(API + path, options).then(r => r.json());
        }

        function get(path) {
            return api(path);
        }

        function post(path, body) {
            return api(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        function put(path, body) {
            return api(path, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        function del(path) {
            return api(path, { method: 'DELETE' });
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = String(s);
            return div.innerHTML;
        }

        function showError(container, message) {
            container.classList.add('error');
            container.innerHTML = '<pre>' + escapeHtml(message) + '</pre>';
        }

        function setActiveNav(viewId, tableName) {
            document.querySelectorAll('.sidebar .nav-item').forEach(el => {
                el.classList.toggle('active', el.dataset.view === viewId && (el.dataset.table || '') === (tableName || ''));
            });
        }

        function parseValueByType(raw, typeName) {
            if (raw === '') return undefined;
            if (raw.toLowerCase() === 'null') return null;
            const t = (typeName || '').toUpperCase();
            if (t.includes('INT')) {
                const n = Number(raw);
                return Number.isFinite(n) ? Math.trunc(n) : raw;
            }
            if (t.includes('REAL') || t.includes('FLOA') || t.includes('DOUB') || t.includes('NUM')) {
                const n = Number(raw);
                return Number.isFinite(n) ? n : raw;
            }
            return raw;
        }

        function renderInfoTable(title, obj) {
            const rows = Object.keys(obj || {}).map(k => {
                const v = obj[k];
                return '<tr><td>' + escapeHtml(k) + '</td><td>' + escapeHtml(v == null ? '' : v) + '</td></tr>';
            }).join('');
            return '<h3>' + escapeHtml(title) + '</h3>' +
                '<table class="data-table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>' + rows + '</tbody></table>';
        }

        function showInfoView() {
            setActiveNav('info');
            const wrap = document.getElementById('workspace');
            wrap.innerHTML = '<h2>System / Database Info</h2><div id="info-result" class="result-box">Loading...</div>';
            const box = document.getElementById('info-result');
            get('/system/info').then(res => {
                if (!res.success) {
                    showError(box, (res.error && (res.error.code + ': ' + res.error.message)) || 'Failed to load info');
                    return;
                }
                const data = res.data || {};
                let html = '';
                html += renderInfoTable('Database', data.database || {});
                html += renderInfoTable('Device', data.device || {});
                html += renderInfoTable('App', data.app || {});
                box.classList.remove('error');
                box.innerHTML = html;
            }).catch(e => {
                showError(box, e.message || 'Failed to load info');
            });
        }

        // ---------------- Left: table list ----------------
        function loadTableList() {
            const container = document.getElementById('table-list');
            container.innerHTML = '<button type="button" class="nav-item loading">Loading...</button>';
            get('/tables').then(res => {
                if (!res.success) {
                    container.innerHTML = '<span class="empty" style="padding:8px 12px;color:#c00;">Failed to load tables</span>';
                    return;
                }
                container.innerHTML = '';
                const tables = res.data || [];
                tables.forEach(t => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'nav-item';
                    b.textContent = t.name;
                    b.dataset.view = 'table';
                    b.dataset.table = t.name;
                    b.onclick = () => selectTable(t.name);
                    container.appendChild(b);
                });
                if (tables.length === 0) {
                    container.innerHTML = '<span class="empty" style="padding:8px 12px;display:block;">No tables</span>';
                }
            }).catch(e => {
                container.innerHTML = '<span class="empty" style="padding:8px 12px;color:#c00;">' + escapeHtml(e.message) + '</span>';
            });
        }

        // ---------------- Right: SQL view ----------------
        function showSqlView() {
            setActiveNav('sql');
            const wrap = document.getElementById('workspace');
            wrap.innerHTML =
                '<h2>Execute SQL</h2>' +
                '<div class="form-group"><label>SQL (supports ? params)</label><textarea id="sql-text">SELECT * FROM Product LIMIT 10</textarea></div>' +
                '<div class="form-group"><label>Params JSON array</label><input id="sql-params" type="text" value="[]"></div>' +
                '<button type="button" class="run" id="sql-run">Run</button>' +
                '<div id="sql-result" class="result-box"></div>';
            document.getElementById('sql-run').onclick = runSql;
        }

        function runSql() {
            const sql = (document.getElementById('sql-text').value || '').trim();
            const paramsInput = (document.getElementById('sql-params').value || '').trim();
            const resultEl = document.getElementById('sql-result');
            if (!sql) {
                showError(resultEl, 'SQL is empty');
                return;
            }

            let params = [];
            try {
                params = paramsInput ? JSON.parse(paramsInput) : [];
                if (!Array.isArray(params)) params = [];
            } catch (_e) {
                showError(resultEl, 'Params must be JSON array');
                return;
            }

            resultEl.classList.remove('error');
            resultEl.innerHTML = 'Running...';
            post('/db/sql', { sql, params }).then(res => {
                if (!res.success) {
                    showError(resultEl, (res.error && (res.error.code + ': ' + res.error.message)) || 'SQL failed');
                    return;
                }
                const data = res.data || {};
                if (data.type === 'query') {
                    const cols = data.columns || [];
                    const rows = data.rows || [];
                    let html = '';
                    if (res.meta && res.meta.executionTime != null) {
                        html += '<div class="meta">Execution time: ' + escapeHtml(res.meta.executionTime) + 's</div>';
                    }
                    html += '<table class="data-table"><thead><tr>' + cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') + '</tr></thead><tbody>';
                    rows.forEach(row => {
                        html += '<tr>' + row.map(v => '<td>' + escapeHtml(v == null ? 'NULL' : v) + '</td>').join('') + '</tr>';
                    });
                    html += '</tbody></table>';
                    resultEl.innerHTML = html;
                } else {
                    resultEl.innerHTML = '<pre>' +
                        'type: ' + escapeHtml(data.type || '') + '\n' +
                        'rowsAffected: ' + escapeHtml(data.rowsAffected || 0) + '\n' +
                        'lastInsertId: ' + escapeHtml(data.lastInsertId || 0) +
                        '</pre>';
                }
            }).catch(e => {
                showError(resultEl, e.message || 'Request failed');
            });
        }

        // ---------------- Right: Table workspace ----------------
        function selectTable(tableName) {
            state.tableName = tableName;
            state.page = 1;
            state.perPage = 50;
            state.sort = 'rowid';
            state.order = 'ASC';
            state.editingRowid = null;

            setActiveNav('table', tableName);
            const wrap = document.getElementById('workspace');
            wrap.innerHTML = '<h2>Table: ' + escapeHtml(tableName) + '</h2><div id="table-content" class="result-box">Loading schema...</div>';
            const content = document.getElementById('table-content');

            get('/tables/' + encodeURIComponent(tableName) + '/schema')
                .then(schemaRes => {
                    if (!schemaRes.success) {
                        showError(content, (schemaRes.error && schemaRes.error.message) || 'Failed to load schema');
                        return;
                    }
                    state.schema = schemaRes.data;
                    renderTableWorkspace(content);
                    loadRows();
                })
                .catch(e => showError(content, e.message || 'Failed to load schema'));
        }

        function renderTableWorkspace(content) {
            const schema = state.schema || {};
            const columns = schema.columns || [];

            const sortOptions = ['rowid'].concat(columns.map(c => c.name))
                .map(name => '<option value="' + escapeHtml(name) + '"' + (name === state.sort ? ' selected' : '') + '>' + escapeHtml(name) + '</option>')
                .join('');

            let insertForm = '<h3>Insert Row</h3><form id="insert-form"><div class="insert-grid">';
            columns.forEach(col => {
                insertForm += '<div class="form-group">' +
                    '<label>' + escapeHtml(col.name) + ' <span class="muted">(' + escapeHtml(col.type || 'TEXT') + (col.notnull ? ', NOT NULL' : '') + (col.pk ? ', PK' : '') + ')</span></label>' +
                    '<input type="text" data-col="' + escapeHtml(col.name) + '" data-type="' + escapeHtml(col.type || '') + '" placeholder="leave empty to skip / type null for NULL">' +
                    '</div>';
            });
            insertForm += '</div><button type="submit" class="plain-btn">Insert</button></form><div id="insert-status" class="status-line"></div>';

            content.classList.remove('error');
            content.innerHTML =
                '<div class="schema-ddl">' + escapeHtml(schema.sql || '') + '</div>' +
                '<h3>Columns</h3>' +
                '<table class="data-table"><thead><tr><th>cid</th><th>name</th><th>type</th><th>pk</th><th>notnull</th></tr></thead><tbody>' +
                columns.map(c => '<tr><td>' + escapeHtml(c.cid) + '</td><td>' + escapeHtml(c.name) + '</td><td>' + escapeHtml(c.type) + '</td><td>' + escapeHtml(c.pk) + '</td><td>' + escapeHtml(c.notnull) + '</td></tr>').join('') +
                '</tbody></table>' +
                insertForm +
                '<h3>Rows</h3>' +
                '<div class="toolbar">' +
                '<select id="sort-col">' + sortOptions + '</select>' +
                '<select id="sort-order"><option value="ASC"' + (state.order === 'ASC' ? ' selected' : '') + '>ASC</option><option value="DESC"' + (state.order === 'DESC' ? ' selected' : '') + '>DESC</option></select>' +
                '<input id="per-page" type="number" min="1" max="500" value="' + escapeHtml(state.perPage) + '">' +
                '<button id="apply-sort" type="button" class="plain-btn">Apply</button>' +
                '</div>' +
                '<div id="rows-meta" class="meta"></div>' +
                '<div id="rows-section"></div>';

            document.getElementById('apply-sort').onclick = () => {
                state.sort = document.getElementById('sort-col').value || 'rowid';
                state.order = document.getElementById('sort-order').value || 'ASC';
                state.perPage = Math.max(1, Number(document.getElementById('per-page').value || 50));
                state.page = 1;
                loadRows();
            };

            document.getElementById('insert-form').onsubmit = onInsertSubmit;
        }

        function onInsertSubmit(e) {
            e.preventDefault();
            if (!state.tableName || !state.schema) return;
            const statusEl = document.getElementById('insert-status');
            const payload = {};
            const inputs = document.querySelectorAll('#insert-form input[data-col]');
            inputs.forEach(input => {
                const col = input.dataset.col;
                const type = input.dataset.type || '';
                const raw = (input.value || '').trim();
                const parsed = parseValueByType(raw, type);
                if (parsed !== undefined) payload[col] = parsed;
            });

            post('/tables/' + encodeURIComponent(state.tableName) + '/rows', payload).then(res => {
                if (!res.success) {
                    statusEl.textContent = 'Insert failed: ' + ((res.error && res.error.message) || 'Unknown error');
                    return;
                }
                statusEl.textContent = 'Inserted rowid: ' + ((res.data && res.data.rowid) || '');
                document.querySelectorAll('#insert-form input[data-col]').forEach(i => { i.value = ''; });
                loadRows();
            }).catch(err => {
                statusEl.textContent = 'Insert failed: ' + err.message;
            });
        }

        function loadRows() {
            if (!state.tableName) return;
            const rowsSection = document.getElementById('rows-section');
            const rowsMeta = document.getElementById('rows-meta');
            closeEditModal();
            rowsSection.innerHTML = 'Loading rows...';
            rowsMeta.textContent = '';

            const query = '?_page=' + encodeURIComponent(state.page) +
                '&_per_page=' + encodeURIComponent(state.perPage) +
                '&_sort=' + encodeURIComponent(state.sort) +
                '&_order=' + encodeURIComponent(state.order);

            get('/tables/' + encodeURIComponent(state.tableName) + '/rows' + query).then(res => {
                if (!res.success) {
                    rowsSection.innerHTML = '<div class="result-box error"><pre>' + escapeHtml((res.error && res.error.message) || 'Load rows failed') + '</pre></div>';
                    return;
                }

                const data = res.data || {};
                const cols = data.columns || [];
                const rows = data.rows || [];
                const meta = res.meta || {};
                const total = Number(meta.total_rows || 0);
                const page = Number(meta.page || state.page);
                const perPage = Number(meta.per_page || state.perPage);
                const totalPages = Math.max(1, Math.ceil(total / perPage));

                rowsMeta.textContent = 'Page ' + page + ' / ' + totalPages + ', total rows: ' + total;

                if (rows.length === 0) {
                    rowsSection.innerHTML = '<p class="empty">No rows</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr>' +
                    cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') +
                    '<th>Actions</th></tr></thead><tbody>';

                rows.forEach((row, rowIndex) => {
                    const rowid = row[0];
                    html += '<tr data-row-index="' + rowIndex + '">' +
                        row.map(v => '<td>' + escapeHtml(v == null ? 'NULL' : v) + '</td>').join('') +
                        '<td class="row-actions">' +
                        '<button type="button" class="small-btn row-edit" data-rowid="' + escapeHtml(rowid) + '" data-row-index="' + rowIndex + '">Edit</button>' +
                        '<button type="button" class="small-btn row-del" data-rowid="' + escapeHtml(rowid) + '">Delete</button>' +
                        '</td></tr>';
                });
                html += '</tbody></table>';
                html += '<div class="pagination">' +
                    '<button type="button" class="small-btn" id="prev-page"' + (page <= 1 ? ' disabled' : '') + '>Prev</button>' +
                    '<button type="button" class="small-btn" id="next-page"' + (page >= totalPages ? ' disabled' : '') + '>Next</button>' +
                    '</div>';
                rowsSection.innerHTML = html;

                rowsSection.querySelector('#prev-page').onclick = () => {
                    if (state.page > 1) {
                        state.page -= 1;
                        loadRows();
                    }
                };
                rowsSection.querySelector('#next-page').onclick = () => {
                    if (state.page < totalPages) {
                        state.page += 1;
                        loadRows();
                    }
                };

                rowsSection.querySelectorAll('.row-edit').forEach(btn => {
                    btn.onclick = () => {
                        const rowid = btn.dataset.rowid;
                        const idx = Number(btn.dataset.rowIndex);
                        openEditPanel(rowid, cols, rows[idx]);
                    };
                });

                rowsSection.querySelectorAll('.row-del').forEach(btn => {
                    btn.onclick = () => {
                        const rowid = btn.dataset.rowid;
                        onDeleteRow(rowid);
                    };
                });
            }).catch(e => {
                rowsSection.innerHTML = '<div class="result-box error"><pre>' + escapeHtml(e.message || 'Request failed') + '</pre></div>';
            });
        }

        function closeEditModal() {
            const mask = document.getElementById('edit-modal-mask');
            const body = document.getElementById('edit-modal-body');
            const status = document.getElementById('edit-modal-status');
            if (mask) mask.style.display = 'none';
            if (body) body.innerHTML = '';
            if (status) status.textContent = '';
            state.editingRowid = null;
        }

        function openEditPanel(rowid, columns, rowValues) {
            if (!state.tableName || !state.schema || !rowValues || !columns) return;
            state.editingRowid = rowid;
            const mask = document.getElementById('edit-modal-mask');
            const body = document.getElementById('edit-modal-body');
            const title = document.getElementById('edit-modal-title');
            const status = document.getElementById('edit-modal-status');
            if (!mask || !body || !title || !status) return;

            const schemaCols = state.schema.columns || [];
            const valueByName = {};
            for (let i = 0; i < columns.length; i++) {
                valueByName[columns[i]] = rowValues[i];
            }

            let html = '<form id="edit-form"><div class="insert-grid">';

            schemaCols.forEach(col => {
                if (col.name === 'rowid') return;
                const current = valueByName[col.name];
                html += '<div class="form-group">' +
                    '<label>' + escapeHtml(col.name) + ' <span class="muted">(' + escapeHtml(col.type || 'TEXT') + ')</span></label>' +
                    '<input type="text" data-col="' + escapeHtml(col.name) + '" data-type="' + escapeHtml(col.type || '') + '" value="' + escapeHtml(current == null ? '' : current) + '">' +
                    '</div>';
            });

            html += '</div><div style="margin-top:10px;">' +
                '<button type="submit" class="plain-btn">Save</button> ' +
                '<button type="button" class="small-btn" id="edit-cancel">Cancel</button>' +
                '</div></form>';
            title.textContent = 'Edit rowid = ' + rowid;
            status.textContent = '';
            body.innerHTML = html;
            mask.style.display = 'flex';

            document.getElementById('edit-form').onsubmit = onEditSubmit;
            document.getElementById('edit-cancel').onclick = () => {
                closeEditModal();
            };
        }

        function onEditSubmit(e) {
            e.preventDefault();
            if (!state.tableName || !state.editingRowid) return;
            const status = document.getElementById('edit-modal-status');
            const payload = {};

            document.querySelectorAll('#edit-form input[data-col]').forEach(input => {
                const col = input.dataset.col;
                const type = input.dataset.type || '';
                const raw = (input.value || '').trim();
                const parsed = parseValueByType(raw, type);
                if (parsed !== undefined) payload[col] = parsed;
            });

            put('/tables/' + encodeURIComponent(state.tableName) + '/rows/' + encodeURIComponent(state.editingRowid), payload).then(res => {
                if (!res.success) {
                    if (status) status.textContent = 'Update failed: ' + ((res.error && res.error.message) || 'Unknown error');
                    return;
                }
                if (status) status.textContent = 'Updated.';
                closeEditModal();
                loadRows();
            }).catch(err => {
                if (status) status.textContent = 'Update failed: ' + err.message;
            });
        }

        function onDeleteRow(rowid) {
            if (!state.tableName) return;
            if (!confirm('Delete rowid=' + rowid + ' ?')) return;
            del('/tables/' + encodeURIComponent(state.tableName) + '/rows/' + encodeURIComponent(rowid)).then(res => {
                if (!res.success) {
                    alert('Delete failed: ' + ((res.error && res.error.message) || 'Unknown error'));
                    return;
                }
                loadRows();
            }).catch(e => alert('Delete failed: ' + e.message));
        }

        // Init
        document.getElementById('edit-modal-close').onclick = closeEditModal;
        document.getElementById('edit-modal-mask').onclick = (e) => {
            if (e.target && e.target.id === 'edit-modal-mask') closeEditModal();
        };
        document.querySelector('.nav-item[data-view="info"]').onclick = showInfoView;
        document.querySelector('.nav-item[data-view="sql"]').onclick = showSqlView;
        loadTableList();
        showSqlView();
    </script>
</body>
</html>
